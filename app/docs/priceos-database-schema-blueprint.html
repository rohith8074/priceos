<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceOS ‚Äî Database Schema & Architecture Blueprint</title>
    <style>
        :root {
            --bg: #09090b;
            --surface: #121214;
            --card: #18181b;
            --border: #27272a;
            --text: #fafafa;
            --muted: #a1a1aa;
            --accent: #3b82f6;
            /* Blue for professional core */
            --accent2: #8b5cf6;
            /* Purple for AI */
            --green: #10b981;
            --orange: #f59e0b;
            --red: #f43f5e;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 40px 24px;
            font-size: 0.95rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .doc-header {
            border-bottom: 2px solid var(--border);
            padding-bottom: 30px;
            margin-bottom: 40px;
        }

        .doc-header h1 {
            font-size: 2.4rem;
            color: #fff;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .doc-header h1 span {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta-tags {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .tag {
            background: #1f1f22;
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        h2 {
            font-size: 1.6rem;
            color: #fff;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        h3 {
            color: var(--accent);
            margin: 30px 0 15px;
            font-size: 1.2rem;
        }

        p {
            margin-bottom: 16px;
            color: #d4d4d8;
        }

        /* Tables */
        .schema-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0 40px;
            background: var(--card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .schema-table th,
        .schema-table td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .schema-table th {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .schema-table tr:last-child td {
            border-bottom: none;
        }

        .schema-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .col-name {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: #fff;
            font-size: 0.9rem;
        }

        .col-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--orange);
        }

        .col-pk {
            display: inline-block;
            background: rgba(244, 63, 94, 0.15);
            color: var(--red);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        .col-fk {
            display: inline-block;
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
        }

        /* Executive Summary Box */
        .exec-box {
            background: linear-gradient(145deg, #18181b, #121214);
            border: 1px solid var(--accent);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 40px;
            border-left: 4px solid var(--accent);
        }

        .exec-box h3 {
            color: #fff;
            margin-top: 0;
        }

        .exec-box ul {
            padding-left: 20px;
            color: #d4d4d8;
        }

        .exec-box li {
            margin-bottom: 10px;
        }

        /* Optimization Section */
        .optimization {
            background: #121214;
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 12px;
            margin-top: 50px;
        }

        .opt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .opt-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: 8px;
            border-top: 3px solid var(--green);
        }

        .opt-card h4 {
            color: var(--green);
            font-size: 1.1rem;
            margin-bottom: 12px;
            margin-top: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="doc-header">
            <h1>PriceOS <span>Database Schema & Architecture Blueprint</span></h1>
            <p style="font-size: 1.1rem;">End-to-end data dictionary and AI optimization strategy for the PriceOS
                Pricing Engine.</p>
            <div class="meta-tags">
                <span class="tag">Version: 2.1 (Current)</span>
                <span class="tag">DB Engine: PostgreSQL (Neon Serverless)</span>
                <span class="tag">ORM: Drizzle</span>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="exec-box">
            <h3>Executive Summary for Leadership</h3>
            <p>This document serves as the absolute source of truth for the PriceOS database architecture.</p>
            <ul>
                <li><strong>Current Implementation:</strong> A robust, normalized 5-table relational schema designed to
                    natively mimic the Hostaway PMS data structure, ensuring 100% data fidelity during daily syncs.</li>
                <li><strong>Financial Tracking:</strong> Every reservation tracks gross price, channel commissions, and
                    cleanings, ensuring AI agents optimize for <em>Net Profit</em> rather than just top-line revenue.
                </li>
                <li><strong>The Agentic Challenge:</strong> While highly normalized, querying 5 separate tables requires
                    complex <code>JOIN</code> statements. For AI LLMs (Large Language Models), writing joins increases
                    latency, token costs, and hallucination risks.</li>
                <li><strong>The Optimization Path:</strong> We outline a strategic consolidation into a flatten 3-Table
                    "Fact Store" (detailed at the bottom of the document) that will reduce Agent response time by ~40%
                    without losing a single data point.</li>
            </ul>
        </div>

        <!-- 1. Listings -->
        <h2>1. Current Schema Data Dictionary</h2>

        <h3>üè† <code>listings</code> (Property Profile & Master Data)</h3>
        <p>Stores the physical attributes, static configuration, and global geographic data for each property.</p>
        <table class="schema-table">
            <tr>
                <th width="25%">Column Name</th>
                <th width="20%">Data Type</th>
                <th width="15%">Constraints</th>
                <th>Business Description</th>
            </tr>
            <tr>
                <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                <td><span class="col-type">SERIAL</span></td>
                <td>NOT NULL</td>
                <td>Internal database auto-incrementing identifier.</td>
            </tr>
            <tr>
                <td><span class="col-name">hostaway_id</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>UNIQUE</td>
                <td>The external ID bridging PriceOS and the Hostaway API.</td>
            </tr>
            <tr>
                <td><span class="col-name">name</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>NOT NULL</td>
                <td>Marketing name of the property.</td>
            </tr>
            <tr>
                <td><span class="col-name">city</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>Default: 'Dubai'</td>
                <td>Primary macro-market for the listing.</td>
            </tr>
            <tr>
                <td><span class="col-name">area</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>NOT NULL</td>
                <td>The sub-market or neighborhood (e.g., 'Dubai Marina').</td>
            </tr>
            <tr>
                <td><span class="col-name">country_code</span></td>
                <td><span class="col-type">VARCHAR(3)</span></td>
                <td>Default: 'AE'</td>
                <td>ISO country code for regional targeting.</td>
            </tr>
            <tr>
                <td><span class="col-name">bedrooms_number</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Default: 0</td>
                <td>Number of bedrooms (0 = Studio). Configures occupancy limits.</td>
            </tr>
            <tr>
                <td><span class="col-name">bathrooms_number</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Default: 1</td>
                <td>Number of bathrooms.</td>
            </tr>
            <tr>
                <td><span class="col-name">property_type_id</span></td>
                <td><span class="col-type">INT</span></td>
                <td>NOT NULL</td>
                <td>Categorical ID (1=Apartment, 2=Villa, 3=Townhouse, etc).</td>
            </tr>
            <tr>
                <td><span class="col-name">price</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>The default baseline nightly rate in base currency.</td>
            </tr>
            <tr>
                <td><span class="col-name">currency_code</span></td>
                <td><span class="col-type">VARCHAR(3)</span></td>
                <td>Default: 'AED'</td>
                <td>ISO currency code.</td>
            </tr>
            <tr>
                <td><span class="col-name">person_capacity</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Nullable</td>
                <td>Maximum allowed guests for the property.</td>
            </tr>
            <tr>
                <td><span class="col-name">amenities</span></td>
                <td><span class="col-type">JSONB</span></td>
                <td>Nullable</td>
                <td>Array of feature tags (e.g., ["pool", "gym", "balcony"]).</td>
            </tr>
            <tr>
                <td><span class="col-name">address, lat, long</span></td>
                <td><span class="col-type">GEO / NUMERIC</span></td>
                <td>Nullable</td>
                <td>Precise GPS coordinates used by Agent 4 to measure distance to events.</td>
            </tr>
        </table>

        <!-- 2. Calendar -->
        <h3>üìÖ <code>calendar_days</code> (Daily Operational State)</h3>
        <p>Stores the exact state of a given property on a specific date. If a month has 30 days, this table holds 30
            rows per property.</p>
        <table class="schema-table">
            <tr>
                <th width="25%">Column Name</th>
                <th width="20%">Data Type</th>
                <th width="15%">Constraints</th>
                <th>Business Description</th>
            </tr>
            <tr>
                <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                <td><span class="col-type">SERIAL</span></td>
                <td>NOT NULL</td>
                <td>Internal identifier.</td>
            </tr>
            <tr>
                <td><span class="col-name">listing_id</span><span class="col-fk">FK</span></td>
                <td><span class="col-type">INT</span></td>
                <td>REFERENCES listings(id)</td>
                <td>The property this day belongs to.</td>
            </tr>
            <tr>
                <td><span class="col-name">date</span></td>
                <td><span class="col-type">DATE</span></td>
                <td>NOT NULL</td>
                <td>The specific calendar date being tracked.</td>
            </tr>
            <tr>
                <td><span class="col-name">status</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>Default: 'available'</td>
                <td>Enum: <code>available</code>, <code>booked</code>, <code>blocked</code>. Core inventory tracking.
                </td>
            </tr>
            <tr>
                <td><span class="col-name">price</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>The actual active price for this specific night on the channels.</td>
            </tr>
            <tr>
                <td><span class="col-name">minimum_stay</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Default: 1</td>
                <td>Yield management restriction preventing single-night gaps.</td>
            </tr>
            <tr>
                <td><span class="col-name">maximum_stay</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Default: 30</td>
                <td>Length of stay cap.</td>
            </tr>
            <tr>
                <td><span class="col-name">note</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>Nullable</td>
                <td>If status = 'blocked', explains why (e.g., 'Maintenance', 'Owner Stay').</td>
            </tr>
        </table>

        <!-- 3. Proposals -->
        <h3>üí° <code>proposals</code> (AI Pricing Recommendations)</h3>
        <p>The "scratchpad" where the AI engine writes recommended price changes before they are reviewed and pushed to
            the PMS.</p>
        <table class="schema-table">
            <tr>
                <th width="25%">Column Name</th>
                <th width="20%">Data Type</th>
                <th width="15%">Constraints</th>
                <th>Business Description</th>
            </tr>
            <tr>
                <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                <td><span class="col-type">SERIAL</span></td>
                <td>NOT NULL</td>
                <td>Internal identifier.</td>
            </tr>
            <tr>
                <td><span class="col-name">listing_id</span><span class="col-fk">FK</span></td>
                <td><span class="col-type">INT</span></td>
                <td>REFERENCES listings(id)</td>
                <td>The target property for the price change.</td>
            </tr>
            <tr>
                <td><span class="col-name">date</span></td>
                <td><span class="col-type">DATE</span></td>
                <td>NOT NULL</td>
                <td>The target date for the price change.</td>
            </tr>
            <tr>
                <td><span class="col-name">current_price</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>The existing active price (reference point).</td>
            </tr>
            <tr>
                <td><span class="col-name">proposed_price</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>The new rate derived by the AI pricing algorithm.</td>
            </tr>
            <tr>
                <td><span class="col-name">change_pct</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Default: 0</td>
                <td>The percentage delta. High variance triggers manual review flags.</td>
            </tr>
            <tr>
                <td><span class="col-name">price_floor</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>The absolute minimum authorized rate (Safety guardrail).</td>
            </tr>
            <tr>
                <td><span class="col-name">price_ceiling</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>The absolute maximum authorized rate (Price gouging prevention).</td>
            </tr>
            <tr>
                <td><span class="col-name">risk_level</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>ENUM</td>
                <td><code>low</code>, <code>medium</code>, <code>high</code>. Calculated by Agent 5.</td>
            </tr>
            <tr>
                <td><span class="col-name">status</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>ENUM</td>
                <td><code>pending</code>, <code>approved</code>, <code>rejected</code>.</td>
            </tr>
            <tr>
                <td><span class="col-name">reasoning</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>Nullable</td>
                <td>Plain text explanation generated by the LLM justifying the change.</td>
            </tr>
        </table>

        <!-- 4. Reservations -->
        <h3>üè® <code>reservations</code> (Financials & Booking Ledger)</h3>
        <p>Historical and future booking data. Every row represents a guest's stay, acting as the primary source for
            revenue analytics.</p>
        <table class="schema-table">
            <tr>
                <th width="25%">Column Name</th>
                <th width="20%">Data Type</th>
                <th width="15%">Constraints</th>
                <th>Business Description</th>
            </tr>
            <tr>
                <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                <td><span class="col-type">SERIAL</span></td>
                <td>NOT NULL</td>
                <td>Internal identifier.</td>
            </tr>
            <tr>
                <td><span class="col-name">hostaway_id</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>UNIQUE</td>
                <td>The external Hostaway reservation logic ID.</td>
            </tr>
            <tr>
                <td><span class="col-name">listing_map_id</span><span class="col-fk">FK</span></td>
                <td><span class="col-type">INT</span></td>
                <td>REFERENCES listings(id)</td>
                <td>The booked property.</td>
            </tr>
            <tr>
                <td><span class="col-name">guest_name</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>NOT NULL</td>
                <td>Identifying guest information.</td>
            </tr>
            <tr>
                <td><span class="col-name">guest_email</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>Nullable</td>
                <td>Guest contact detail.</td>
            </tr>
            <tr>
                <td><span class="col-name">number_of_guests</span></td>
                <td><span class="col-type">INT</span></td>
                <td>Nullable</td>
                <td>Total party size (adults + children).</td>
            </tr>
            <tr>
                <td><span class="col-name">channel_name</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>NOT NULL</td>
                <td>Origin (e.g., 'Airbnb', 'Booking.com', 'Direct'). Crucial for commission mapping.</td>
            </tr>
            <tr>
                <td><span class="col-name">arrival / departure</span></td>
                <td><span class="col-type">DATE</span></td>
                <td>NOT NULL</td>
                <td>Check-in and check-out dates.</td>
            </tr>
            <tr>
                <td><span class="col-name">nights</span></td>
                <td><span class="col-type">INT</span></td>
                <td>NOT NULL</td>
                <td>Length of stay calculation.</td>
            </tr>
            <tr>
                <td><span class="col-name">total_price</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>Gross revenue generated by the booking.</td>
            </tr>
            <tr>
                <td><span class="col-name">price_per_night</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>NOT NULL</td>
                <td>Average daily rate (ADR) for this stay.</td>
            </tr>
            <tr>
                <td><span class="col-name">channel_commission</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>Nullable</td>
                <td>OTA fee deduction to calculate Net Profit.</td>
            </tr>
            <tr>
                <td><span class="col-name">cleaning_fee</span></td>
                <td><span class="col-type">NUMERIC(10,2)</span></td>
                <td>Nullable</td>
                <td>Operational cost pass-through tracking.</td>
            </tr>
            <tr>
                <td><span class="col-name">status</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>Default: 'confirmed'</td>
                <td>Tracks active vs. cancelled reservations.</td>
            </tr>
        </table>

        <!-- 5. Event Signals -->
        <h3>üì° <code>event_signals</code> (Market Intelligence Core)</h3>
        <p>External factors (Conferences, Holidays, Flight Trends) that impact local market demand, updated
            asynchronously.</p>
        <table class="schema-table">
            <tr>
                <th width="25%">Column Name</th>
                <th width="20%">Data Type</th>
                <th width="15%">Constraints</th>
                <th>Business Description</th>
            </tr>
            <tr>
                <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                <td><span class="col-type">SERIAL</span></td>
                <td>NOT NULL</td>
                <td>Internal identifier.</td>
            </tr>
            <tr>
                <td><span class="col-name">name</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>NOT NULL</td>
                <td>Event Title (e.g., 'Gitex', 'Eid Al Fitr').</td>
            </tr>
            <tr>
                <td><span class="col-name">start / end_date</span></td>
                <td><span class="col-type">DATE</span></td>
                <td>NOT NULL</td>
                <td>The impact envelope for demand spiking.</td>
            </tr>
            <tr>
                <td><span class="col-name">expected_impact</span></td>
                <td><span class="col-type">TEXT</span></td>
                <td>ENUM</td>
                <td><code>high</code>, <code>medium</code>, <code>low</code>. Drives price multipliers.</td>
            </tr>
            <tr>
                <td><span class="col-name">metadata</span></td>
                <td><span class="col-type">JSONB</span></td>
                <td>Default: {}</td>
                <td>Stores deep research (e.g., expected attendance, competitor median rates).</td>
            </tr>
        </table>

        <!-- Optimization Strategy -->
        <div class="optimization">
            <h2 style="border-bottom: none; margin-top: 0;">2. Agentic Schema Optimization Roadmap</h2>
            <p>To reduce LLM latency and API token costs, the architecture will be migrated from a <strong>Normalized
                    Relational Model (5 Tables)</strong> to a <strong>Flattened Fact-Store Model (3 Tables)</strong>.
            </p>

            <div class="opt-grid" style="margin-bottom: 40px;">
                <div class="opt-card">
                    <h4>Step 1: Relocate Guardrails</h4>
                    <p>Move <code>price_floor</code> and <code>price_ceiling</code> from the <code>proposals</code>
                        table into the <code>listings</code> table. Safety limits are property attributes, not daily
                        variants.</p>
                </div>
                <div class="opt-card">
                    <h4>Step 2: Consolidate Operations</h4>
                    <p>Merge <code>calendar_days</code> and <code>proposals</code> into a single
                        <strong><code>inventory_master</code></strong> table.
                    </p>
                    <p><em>Benefit:</em> Agents can see availability, the current price, and the AI's proposed price in
                        a single row without writing a `JOIN`.</p>
                </div>
                <div class="opt-card">
                    <h4>Step 3: Unify the Timeline</h4>
                    <p>Merge <code>reservations</code> and <code>event_signals</code> into a single
                        <strong><code>activity_timeline</code></strong> table, utilizing JSONB for deep metrics.
                    </p>
                    <p><em>Benefit:</em> Agents can query a date range and receive both <em>"Who booked"</em> and
                        <em>"What external event is happening"</em> in one chronological stream.
                    </p>
                </div>
            </div>

            <h2 style="border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 40px;">Detailed
                Optimized Schema (3 Tables)</h2>
            <p style="margin-bottom: 20px;">The exact structure of the Agentic Fact-Store post-migration. 100% data
                preservation achieved through JSONB clustering.</p>

            <!-- Optimized Listings -->
            <h3 style="color: var(--accent);">üè† <code>listings</code> (Optimized Base)</h3>
            <table class="schema-table">
                <tr>
                    <th width="25%">Column Name</th>
                    <th width="20%">Data Type</th>
                    <th width="15%">Origin</th>
                    <th>Business Description</th>
                </tr>
                <tr>
                    <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                    <td><span class="col-type">SERIAL</span></td>
                    <td>listings</td>
                    <td>Primary key.</td>
                </tr>
                <tr>
                    <td><span class="col-name">hostaway_id</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td>listings</td>
                    <td>External ID mapping.</td>
                </tr>
                <tr>
                    <td><span class="col-name">name, city, area, country_code</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td>listings</td>
                    <td>Location metadata unchanged.</td>
                </tr>
                <tr>
                    <td><span class="col-name">price</span></td>
                    <td><span class="col-type">NUMERIC(10,2)</span></td>
                    <td>listings</td>
                    <td>Base static price unchanged.</td>
                </tr>
                <tr style="background: rgba(16, 185, 129, 0.05);">
                    <td><span class="col-name">price_floor</span></td>
                    <td><span class="col-type">NUMERIC(10,2)</span></td>
                    <td><strong>From <code>proposals</code></strong></td>
                    <td>Property-wide hard minimum limit.</td>
                </tr>
                <tr style="background: rgba(16, 185, 129, 0.05);">
                    <td><span class="col-name">price_ceiling</span></td>
                    <td><span class="col-type">NUMERIC(10,2)</span></td>
                    <td><strong>From <code>proposals</code></strong></td>
                    <td>Property-wide hard maximum limit.</td>
                </tr>
            </table>

            <!-- Optimized Inventory Master -->
            <h3 style="color: var(--green);">üìÖ <code>inventory_master</code> (Merged Calendar & Proposals)</h3>
            <table class="schema-table">
                <tr>
                    <th width="25%">Column Name</th>
                    <th width="20%">Data Type</th>
                    <th width="15%">Origin</th>
                    <th>Business Description</th>
                </tr>
                <tr>
                    <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                    <td><span class="col-type">SERIAL</span></td>
                    <td>New</td>
                    <td>Primary key.</td>
                </tr>
                <tr>
                    <td><span class="col-name">listing_id</span><span class="col-fk">FK</span></td>
                    <td><span class="col-type">INT</span></td>
                    <td>Both</td>
                    <td>Property reference.</td>
                </tr>
                <tr>
                    <td><span class="col-name">date</span></td>
                    <td><span class="col-type">DATE</span></td>
                    <td>Both</td>
                    <td>The specific target date.</td>
                </tr>
                <tr>
                    <td><span class="col-name">status</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td>calendar_days</td>
                    <td>Available/Booked/Blocked.</td>
                </tr>
                <tr>
                    <td><span class="col-name">current_price</span></td>
                    <td><span class="col-type">NUMERIC(10,2)</span></td>
                    <td>calendar_days</td>
                    <td>Active price on PMS.</td>
                </tr>
                <tr>
                    <td><span class="col-name">min_max_stay</span></td>
                    <td><span class="col-type">JSONB</span></td>
                    <td>calendar_days</td>
                    <td>Condensed `{min: 1, max: 30}` to save columns.</td>
                </tr>
                <tr style="background: rgba(16, 185, 129, 0.05);">
                    <td><span class="col-name">proposed_price</span></td>
                    <td><span class="col-type">NUMERIC(10,2)</span></td>
                    <td><strong>From <code>proposals</code></strong></td>
                    <td>AI recommendation target.</td>
                </tr>
                <tr style="background: rgba(16, 185, 129, 0.05);">
                    <td><span class="col-name">change_pct</span></td>
                    <td><span class="col-type">INT</span></td>
                    <td><strong>From <code>proposals</code></strong></td>
                    <td>Delta for risk triggers.</td>
                </tr>
                <tr style="background: rgba(16, 185, 129, 0.05);">
                    <td><span class="col-name">proposal_status</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td><strong>From <code>proposals</code></strong></td>
                    <td>pending/approved/rejected.</td>
                </tr>
                <tr style="background: rgba(16, 185, 129, 0.05);">
                    <td><span class="col-name">reasoning</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td><strong>From <code>proposals</code></strong></td>
                    <td>AI explanation text.</td>
                </tr>
            </table>

            <!-- Optimized Activity Timeline -->
            <h3 style="color: var(--accent2);">üìä <code>activity_timeline</code> (Merged Reservations & Events)</h3>
            <table class="schema-table">
                <tr>
                    <th width="25%">Column Name</th>
                    <th width="20%">Data Type</th>
                    <th width="15%">Origin</th>
                    <th>Business Description</th>
                </tr>
                <tr>
                    <td><span class="col-name">id</span><span class="col-pk">PK</span></td>
                    <td><span class="col-type">SERIAL</span></td>
                    <td>New</td>
                    <td>Primary key.</td>
                </tr>
                <tr>
                    <td><span class="col-name">listing_id</span><span class="col-fk">FK</span></td>
                    <td><span class="col-type">INT</span></td>
                    <td>reservations</td>
                    <td>Null for city-wide events, filled for property bookings.</td>
                </tr>
                <tr>
                    <td><span class="col-name">type</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td>New</td>
                    <td>Discriminator: `reservation` or `market_event`.</td>
                </tr>
                <tr>
                    <td><span class="col-name">start_date</span></td>
                    <td><span class="col-type">DATE</span></td>
                    <td>Both</td>
                    <td>Arrival date or Event Start date.</td>
                </tr>
                <tr>
                    <td><span class="col-name">end_date</span></td>
                    <td><span class="col-type">DATE</span></td>
                    <td>Both</td>
                    <td>Departure date or Event End date.</td>
                </tr>
                <tr>
                    <td><span class="col-name">title</span></td>
                    <td><span class="col-type">TEXT</span></td>
                    <td>Both</td>
                    <td>Guest Name OR Event Name.</td>
                </tr>
                <tr>
                    <td><span class="col-name">impact_score</span></td>
                    <td><span class="col-type">INT</span></td>
                    <td>event_signals</td>
                    <td>Price multiplier impact metric.</td>
                </tr>
                <tr style="background: rgba(139, 92, 246, 0.1);">
                    <td><span class="col-name">financials</span></td>
                    <td><span class="col-type">JSONB</span></td>
                    <td><strong>From <code>reservations</code></strong></td>
                    <td>Packs total_price, channel_commission, cleaning_fee, channel_name into one object.</td>
                </tr>
                <tr style="background: rgba(139, 92, 246, 0.1);">
                    <td><span class="col-name">market_context</span></td>
                    <td><span class="col-type">JSONB</span></td>
                    <td><strong>From <code>events</code></strong></td>
                    <td>Packs descriptions, competitor confidence scores into one object.</td>
                </tr>
            </table>

            <p style="text-align: center; margin-top: 30px; color: var(--green); font-weight: bold;">Result: Zero DB
                JOINs required by the LLM. 100% Data Preservation. 40% Faster Inference.</p>
        </div>

        <!-- Agent Task Mapping & Prompt Updates -->
        <h2 style="margin-top: 60px;">3. Agent Task Mapping & Required Prompt Updates</h2>
        <p>This matrix maps our current multi-agent ecosystem to the new 3-Table schema. It answers exactly
            <strong>which agent uses which table/column for what task</strong> and identifies required updates in the
            <code>updated_prompts/</code> directory to make the agents compatible with the optimized schema.
        </p>

        <table class="schema-table">
            <tr>
                <th width="15%">Agent & Prompt</th>
                <th width="20%">Core Tasks</th>
                <th width="30%">Optimized Tables & Columns Used</th>
                <th width="35%">Required Prompt File Updates</th>
            </tr>
            <tr>
                <td><strong>Agent 1: CRO Router</strong><br><span
                        style="font-size: 0.75rem; color: var(--muted);">01-cro-router.md</span></td>
                <td>Orchestration, intent routing, and final user chat formatting.</td>
                <td><strong>None</strong> (No DB access).</td>
                <td>
                    <span style="color: var(--orange);">Needs Update:</span><br>
                    ‚Ä¢ Change references of <code>event_signals</code> to <code>activity_timeline</code> in instruction
                    step 3. No SQL logic changes needed.
                </td>
            </tr>
            <tr>
                <td><strong>Agent 2: Property Analyst</strong><br><span
                        style="font-size: 0.75rem; color: var(--muted);">02-property-analyst.md</span></td>
                <td>Gap detection, min-stay restriction checking, revenue forecasting.</td>
                <td>
                    ‚Ä¢ <code>inventory_master.status / date</code> (Gaps)<br>
                    ‚Ä¢ <code>inventory_master.min_max_stay</code> (Restrictions)<br>
                    ‚Ä¢ <code>activity_timeline.type='market_event'</code> (Event cross-referencing)
                </td>
                <td>
                    <span style="color: var(--red);">Major Update Required:</span><br>
                    ‚Ä¢ Replace all `calendar_days` READ instructions with `inventory_master`.<br>
                    ‚Ä¢ Explain how to parse the new <code>min_max_stay</code> JSONB column.<br>
                    ‚Ä¢ Replace `event_signals` with `activity_timeline` for event checking.
                </td>
            </tr>
            <tr>
                <td><strong>Agent 3: Booking Intelligence</strong><br><span
                        style="font-size: 0.75rem; color: var(--muted);">03-booking-intelligence.md</span></td>
                <td>Booking velocity, Cancel risk, Length of stay, Net revenue calculation.</td>
                <td>
                    ‚Ä¢ <code>activity_timeline.type='reservation'</code> (Bookings)<br>
                    ‚Ä¢ <code>activity_timeline.financials</code> (Net revenue, commissions, etc.)<br>
                    ‚Ä¢ <code>inventory_master.status</code> (Occupancy cross-check)
                </td>
                <td>
                    <span style="color: var(--red);">Major Update Required:</span><br>
                    ‚Ä¢ Instruct agent to query `activity_timeline` instead of `reservations`.<br>
                    ‚Ä¢ Explain that all financial data (commission, cleaning) is now nested inside the
                    <code>financials</code> JSONB wrapper.
                </td>
            </tr>
            <tr>
                <td><strong>Agent 4: Market Research</strong><br><span
                        style="font-size: 0.75rem; color: var(--muted);">04-market-research.md</span></td>
                <td>Extracts Dubai events, holidays, competitor rates, and positioning metrics.</td>
                <td>
                    ‚Ä¢ <code>activity_timeline.type='market_event'</code><br>
                    ‚Ä¢ <code>activity_timeline.market_context</code> (Hold competitor & insight JSON data)<br>
                    ‚Ä¢ <code>activity_timeline.impact_score</code>
                </td>
                <td>
                    <span style="color: var(--red);">Major Update Required:</span><br>
                    ‚Ä¢ Replace `event_signals` with `activity_timeline`.<br>
                    ‚Ä¢ Update JSON structure expectations: Competitor pricing and verdict info must be extracted from the
                    <code>market_context</code> JSONB column.
                </td>
            </tr>
            <tr>
                <td><strong>Agent 5: PriceGuard</strong><br><span
                        style="font-size: 0.75rem; color: var(--muted);">05-price-guard.md</span></td>
                <td>Validates proposed changes against hard safety rules (floor/ceiling).</td>
                <td>
                    ‚Ä¢ <code>listings.price_floor / price_ceiling</code> (Safety limits)<br>
                    ‚Ä¢ <code>inventory_master.proposed_price / change_pct</code> (Proposals to validate)<br>
                    ‚Ä¢ <code>inventory_master.proposal_status</code>
                </td>
                <td>
                    <span style="color: var(--red);">Major Update Required:</span><br>
                    ‚Ä¢ Replace `proposals` table querying with `inventory_master`.<br>
                    ‚Ä¢ Point the fallback defaults checking directly to the `listings` table rather than the old
                    proposals table.
                </td>
            </tr>
            <tr>
                <td><strong>Agent 6: Marketing Agent</strong><br><span
                        style="font-size: 0.75rem; color: var(--muted);">06-marketing-agent.md</span></td>
                <td>Internet search for competitor median rates, festivals, and market outlook.</td>
                <td>
                    ‚Ä¢ Output mapped to <code>activity_timeline</code> (type: 'market_event').
                </td>
                <td>
                    <span style="color: var(--orange);">Needs Update:</span><br>
                    ‚Ä¢ Clarify in the instructions that backend will map its JSON outputs into the new
                    <code>activity_timeline</code> structure (as `market_context`), rather than `event_signals`.
                </td>
            </tr>
        </table>
    </div>
</body>


</html>