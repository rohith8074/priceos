<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceOS ‚Äî Architecture & Schema Optimization Guide</title>
    <style>
        :root {
            --bg: #09090b;
            --surface: #121214;
            --card: #18181b;
            --border: #27272a;
            --text: #fafafa;
            --muted: #a1a1aa;
            --accent: #f43f5e;
            --accent2: #8b5cf6;
            --green: #10b981;
            --blue: #3b82f6;
            --orange: #f59e0b;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 40px 24px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--muted);
            margin-bottom: 40px;
        }

        h2 {
            font-size: 1.6rem;
            color: var(--text);
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin: 40px 0 20px;
        }

        .erd {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .erd-table {
            background: var(--surface);
            border: 1px solid var(--border);
            border-top: 4px solid var(--blue);
            border-radius: 8px;
            width: 350px;
            flex-grow: 1;
        }

        .erd-header {
            padding: 12px 16px;
            font-weight: 700;
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid var(--border);
        }

        .erd-col {
            padding: 6px 16px;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .erd-col:last-child {
            border-bottom: none;
        }

        .type {
            color: var(--muted);
            font-family: monospace;
            font-size: 0.75rem;
        }

        .pk {
            background: rgba(244, 63, 94, 0.1);
            font-weight: 600;
            color: var(--accent);
        }

        .fk {
            background: rgba(139, 92, 246, 0.1);
            font-weight: 600;
            color: var(--accent2);
        }

        .note-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--orange);
        }

        .note-box h4 {
            color: var(--orange);
            margin-bottom: 8px;
        }

        .opt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .opt-card {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 24px;
            border-radius: 12px;
        }

        .opt-card h3 {
            color: var(--accent);
            margin-bottom: 16px;
        }

        ul {
            padding-left: 20px;
            margin-bottom: 16px;
        }

        li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        code {
            background: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--green);
            border: 1px solid #333;
        }

        .arrow-down {
            text-align: center;
            font-size: 2rem;
            color: var(--muted);
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>PriceOS ‚Äî Current Schema & AI Optimization Path</h1>
        <p class="subtitle">Detailed breakdown of the current implementation and the strategic roadmap to a 3-table
            Agentic architecture.</p>

        <h2>1. Current Implementation (5 Core Tables)</h2>
        <p>This is the exact structure currently deployed in <code>schema.ts</code>. It uses a normalized relational
            model, separating properties, daily prices, bookings, price recommendations, and market events into isolated
            stores.</p>

        <div class="erd">
            <!-- Listings -->
            <div class="erd-table" style="border-top-color: var(--accent);">
                <div class="erd-header">üè† listings</div>
                <div class="erd-col pk">id <span class="type">SERIAL</span></div>
                <div class="erd-col">hostaway_id <span class="type">TEXT</span></div>
                <div class="erd-col">name <span class="type">TEXT</span></div>
                <div class="erd-col">city, area, countryCode <span class="type">TEXT</span></div>
                <div class="erd-col">beds, baths, capacity <span class="type">INT</span></div>
                <div class="erd-col">price <span class="type">NUMERIC(10,2)</span></div>
                <div class="erd-col">amenities <span class="type">JSONB</span></div>
                <div class="erd-col">address, lat, long <span class="type">GEO</span></div>
            </div>

            <!-- Calendar Days -->
            <div class="erd-table" style="border-top-color: var(--blue);">
                <div class="erd-header">üìÖ calendar_days</div>
                <div class="erd-col pk">id <span class="type">SERIAL</span></div>
                <div class="erd-col fk">listing_id <span class="type">INT</span></div>
                <div class="erd-col">date <span class="type">DATE</span></div>
                <div class="erd-col">status <span class="type">TEXT</span></div>
                <div class="erd-col">price <span class="type">NUMERIC(10,2)</span></div>
                <div class="erd-col">min/maxStay <span class="type">INT</span></div>
                <div class="erd-col">note <span class="type">TEXT</span></div>
            </div>

            <!-- Proposals -->
            <div class="erd-table" style="border-top-color: var(--orange);">
                <div class="erd-header">üí° proposals</div>
                <div class="erd-col pk">id <span class="type">SERIAL</span></div>
                <div class="erd-col fk">listing_id <span class="type">INT</span></div>
                <div class="erd-col">date <span class="type">DATE</span></div>
                <div class="erd-col">current/proposed_price <span class="type">NUMERIC</span></div>
                <div class="erd-col">change_pct <span class="type">INT</span></div>
                <div class="erd-col">price_floor/ceiling <span class="type">NUMERIC</span></div>
                <div class="erd-col">risk_level, status <span class="type">TEXT</span></div>
                <div class="erd-col">reasoning <span class="type">TEXT</span></div>
            </div>

            <!-- Reservations -->
            <div class="erd-table" style="border-top-color: var(--green);">
                <div class="erd-header">üè® reservations</div>
                <div class="erd-col pk">id <span class="type">SERIAL</span></div>
                <div class="erd-col fk">listing_map_id <span class="type">INT</span></div>
                <div class="erd-col">guest_name, email <span class="type">TEXT</span></div>
                <div class="erd-col">channel_name <span class="type">TEXT</span></div>
                <div class="erd-col">arrival/departure_date <span class="type">DATE</span></div>
                <div class="erd-col">total_price, price_per_night <span class="type">NUMERIC</span></div>
                <div class="erd-col">commission, cleaning_fee <span class="type">NUMERIC</span></div>
                <div class="erd-col">status <span class="type">TEXT</span></div>
            </div>

            <!-- Event Signals -->
            <div class="erd-table" style="border-top-color: var(--accent2);">
                <div class="erd-header">üì° event_signals</div>
                <div class="erd-col pk">id <span class="type">SERIAL</span></div>
                <div class="erd-col">name <span class="type">TEXT</span></div>
                <div class="erd-col">start_date, end_date <span class="type">DATE</span></div>
                <div class="erd-col">location <span class="type">TEXT</span></div>
                <div class="erd-col">expected_impact <span class="type">TEXT</span></div>
                <div class="erd-col">confidence <span class="type">INT</span></div>
                <div class="erd-col">metadata <span class="type">JSONB</span></div>
            </div>
        </div>

        <div class="note-box">
            <h4>The Problem for AI Agents</h4>
            <p>In this 5-table setup, answering a simple question like <em>"Why are we changing the price next week, and
                    what is our safety limit?"</em> requires an LLM to generate a complex `JOIN` between
                <code>calendar_days</code>, <code>proposals</code>, and potentially <code>event_signals</code>. LLMs
                struggle with complex multi-table joins, increasing latency, hallucination risk, and token costs.</p>
        </div>

        <div class="arrow-down">‚¨á</div>

        <h2>2. How to Optimize for Agentic Orchestration</h2>
        <p>To make the database "Agent-Native," we must shift from a traditional Normalized (3NF) relational model to a
            <strong>Flattened Fact-Store</strong> model. We reduce the schema to exactly 3 tables, giving each Agent a
            single source of truth.</p>

        <div class="opt-grid">
            <div class="opt-card">
                <h3>A. Global Limits move to Listings</h3>
                <p><strong>Current:</strong> <code>price_floor</code> and <code>price_ceiling</code> are stored on every
                    row in the <code>proposals</code> table.</p>
                <p><strong>Optimization:</strong> Move these to <code>listings</code>. Safety guardrails are
                    property-level constraints, not date-level constraints.</p>
                <ul>
                    <li>Agent 5 (PriceGuard) instantly knows the boundaries by querying the property profile just once,
                        rather than scanning 30 rows of daily proposals.</li>
                </ul>
            </div>

            <div class="opt-card">
                <h3>B. Merge Calendar & Proposals</h3>
                <p><strong>Current:</strong> Daily availability is in <code>calendar_days</code>. Recommended changes
                    are in <code>proposals</code>.</p>
                <p><strong>Optimization:</strong> Merge them into a single <code>inventory_master</code> table.</p>
                <ul>
                    <li>Instead of a JOIN, Agent 2 (Property Analyst) reads one row per date.</li>
                    <li>Fields: <code>date</code>, <code>status</code>, <code>current_price</code>,
                        <code>proposed_price</code>, <code>reasoning</code>.</li>
                    <li><strong>Benefit:</strong> SQL generation becomes trivial (e.g.,
                        <code>SELECT * FROM inventory_master WHERE date = 'X'</code>).</li>
                </ul>
            </div>

            <div class="opt-card">
                <h3>C. Merge Reservations & Events</h3>
                <p><strong>Current:</strong> <code>reservations</code> tracks internal bookings.
                    <code>event_signals</code> tracks external reality.</p>
                <p><strong>Optimization:</strong> Unify them into a single chronological <code>activity_timeline</code>
                    table using a <code>type</code> column (<code>'booking'</code> vs <code>'market_event'</code>).</p>
                <ul>
                    <li>Deep details (cleaning fees, competitor rates) are packed into a <code>metadata</code> JSONB
                        column.</li>
                    <li><strong>Benefit:</strong> Agent 3 and Agent 4 query the exact same timeline. We can
                        cross-reference high commissions with local events in a single chronological stream.</li>
                </ul>
            </div>

            <div class="opt-card" style="border-color: var(--green);">
                <h3 style="color: var(--green)">The Ultimate Result</h3>
                <ul>
                    <li><strong>Zero JOINs:</strong> Agents never need to write a JOIN statement.</li>
                    <li><strong>100% Data Retention:</strong> All 70+ columns from the legacy schema survive, nested
                        safely in JSONB where they don't clog up standard analytics.</li>
                    <li><strong>Agent Latency Drop:</strong> Generating simple SELECTs is ~50% faster for LLMs than
                        writing complex relational queries.</li>
                </ul>
            </div>
        </div>
    </div>
</body>

</html>